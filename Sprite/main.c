#include "../fclib.h"

//!< OAM DMA 転送元となるワーク、下位 8 ビットが 0x00 である必要がある
//!< ここでは [0x700, 0x7ff] を使用することとする
#define SPR_WORK_ADDR 0x700

const u8 Palette[] = { 
    COLOR_BLUE, //!< 背景色
    COLOR_RED, 0x27, 0x07, //!< SPR パレット 0
    0, //!< 未使用
    0, 0, 0, //!< SPR パレット 1
    0, //!< 未使用
    0, 0, 0, //!< SPR パレット 2
    0, //!< 未使用
    0, 0, 0, //!< SPR パレット 3
};

//0,0,0,0,0,1,1,1, 1,1,0,0,0,0,0,0,
//0,0,0,0,1,1,1,1, 1,1,1,1,1,0,0,0,
//0,0,0,0,3,3,3,2, 2,3,2,0,0,0,0,0,
//0,0,0,3,2,3,2,2, 2,3,2,2,2,0,0,0,
//0,0,0,3,2,3,3,2, 2,2,3,2,2,2,0,0,
//0,0,0,3,3,2,2,2, 2,3,3,3,3,0,0,0,
//0,0,0,0,0,2,2,2, 2,2,2,2,0,0,0,0,
//0,0,0,0,3,3,1,3, 3,3,0,0,0,0,0,0,

//0,0,0,3,3,3,1,3, 3,1,3,3,3,0,0,0,
//0,0,3,3,3,3,1,1, 1,1,3,3,3,3,0,0,
//0,0,2,2,3,1,2,1, 1,2,1,3,2,2,0,0,
//0,0,2,2,2,1,1,1, 1,1,1,2,2,2,0,0,
//0,0,2,2,1,1,1,1, 1,1,1,1,2,2,0,0,
//0,0,0,0,1,1,1,0, 0,1,1,1,0,0,0,0,
//0,0,0,3,3,3,0,0, 0,0,3,3,3,0,0,0,
//0,0,3,3,3,3,0,0, 0,0,3,3,3,3,0,0,

//!< SPR 用 8x8 x 256 種
const u8 PatternSPR[] = {
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(0&1)<<4|(0&1)<<3|(1&1)<<2|(1&1)<<1|(1&1)<<0, 
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(0&1)<<4|(1&1)<<3|(1&1)<<2|(1&1)<<1|(1&1)<<0,
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(0&1)<<4|(3&1)<<3|(3&1)<<2|(3&1)<<1|(2&1)<<0, 
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(3&1)<<4|(2&1)<<3|(3&1)<<2|(2&1)<<1|(2&1)<<0, 
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(3&1)<<4|(2&1)<<3|(3&1)<<2|(3&1)<<1|(2&1)<<0, 
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(3&1)<<4|(3&1)<<3|(2&1)<<2|(2&1)<<1|(2&1)<<0, 
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(0&1)<<4|(0&1)<<3|(2&1)<<2|(2&1)<<1|(2&1)<<0, 
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(0&1)<<4|(3&1)<<3|(3&1)<<2|(1&1)<<1|(3&1)<<0, 

    (0&2)<<7|(0&2)<<6|(0&2)<<5|(0&2)<<4|(0&2)<<3|(1&2)<<2|(1&2)<<1|(1&2)<<0, 
    (0&2)<<7|(0&2)<<6|(0&2)<<5|(0&2)<<4|(1&2)<<3|(1&2)<<2|(1&2)<<1|(1&2)<<0,
    (0&2)<<7|(0&2)<<6|(0&2)<<5|(0&2)<<4|(3&2)<<3|(3&2)<<2|(3&2)<<1|(2&2)<<0, 
    (0&2)<<7|(0&2)<<6|(0&2)<<5|(3&2)<<4|(2&2)<<3|(3&2)<<2|(2&2)<<1|(2&2)<<0, 
    (0&2)<<7|(0&2)<<6|(0&2)<<5|(3&2)<<4|(2&2)<<3|(3&2)<<2|(3&2)<<1|(2&2)<<0, 
    (0&2)<<7|(0&2)<<6|(0&2)<<5|(3&2)<<4|(3&2)<<3|(2&2)<<2|(2&2)<<1|(2&2)<<0, 
    (0&2)<<7|(0&2)<<6|(0&2)<<5|(0&2)<<4|(0&2)<<3|(2&2)<<2|(2&2)<<1|(2&2)<<0, 
    (0&2)<<7|(0&2)<<6|(0&2)<<5|(0&2)<<4|(3&2)<<3|(3&2)<<2|(1&2)<<1|(3&2)<<0, 

    (1&1)<<7|(1&1)<<6|(0&1)<<5|(0&1)<<4|(0&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0, 
    (1&1)<<7|(1&1)<<6|(1&1)<<5|(1&1)<<4|(1&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0,
    (2&1)<<7|(3&1)<<6|(2&1)<<5|(0&1)<<4|(0&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0,
    (2&1)<<7|(3&1)<<6|(2&1)<<5|(2&1)<<4|(2&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0,
    (2&1)<<7|(2&1)<<6|(3&1)<<5|(2&1)<<4|(2&1)<<3|(2&1)<<2|(0&1)<<1|(0&1)<<0,
    (2&1)<<7|(3&1)<<6|(3&1)<<5|(3&1)<<4|(3&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0,
    (2&1)<<7|(2&1)<<6|(2&1)<<5|(2&1)<<4|(0&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0,
    (3&1)<<7|(3&1)<<6|(0&1)<<5|(0&1)<<4|(0&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0,

    (1&2)<<7|(1&2)<<6|(0&2)<<5|(0&2)<<4|(0&2)<<3|(0&2)<<2|(0&2)<<1|(0&2)<<0, 
    (1&2)<<7|(1&2)<<6|(1&2)<<5|(1&2)<<4|(1&2)<<3|(0&2)<<2|(0&2)<<1|(0&2)<<0,
    (2&2)<<7|(3&2)<<6|(2&2)<<5|(0&2)<<4|(0&2)<<3|(0&2)<<2|(0&2)<<1|(0&2)<<0,
    (2&2)<<7|(3&2)<<6|(2&2)<<5|(2&2)<<4|(2&2)<<3|(0&2)<<2|(0&2)<<1|(0&2)<<0,
    (2&2)<<7|(2&2)<<6|(3&2)<<5|(2&2)<<4|(2&2)<<3|(2&2)<<2|(0&2)<<1|(0&2)<<0,
    (2&2)<<7|(3&2)<<6|(3&2)<<5|(3&2)<<4|(3&2)<<3|(0&2)<<2|(0&2)<<1|(0&2)<<0,
    (2&2)<<7|(2&2)<<6|(2&2)<<5|(2&2)<<4|(0&2)<<3|(0&2)<<2|(0&2)<<1|(0&2)<<0,
    (3&2)<<7|(3&2)<<6|(0&2)<<5|(0&2)<<4|(0&2)<<3|(0&2)<<2|(0&2)<<1|(0&1)<<0,

    (0&1)<<7|(0&1)<<6|(0&1)<<5|(3&1)<<4|(3&1)<<3|(3&1)<<2|(1&1)<<1|(3&1)<<0, 
    (0&1)<<7|(0&1)<<6|(3&1)<<5|(3&1)<<4|(3&1)<<3|(3&1)<<2|(1&1)<<1|(1&1)<<0,
    (0&1)<<7|(0&1)<<6|(2&1)<<5|(2&1)<<4|(3&1)<<3|(1&1)<<2|(2&1)<<1|(1&1)<<0, 
    (0&1)<<7|(0&1)<<6|(2&1)<<5|(2&1)<<4|(2&1)<<3|(1&1)<<2|(1&1)<<1|(1&1)<<0, 
    (0&1)<<7|(0&1)<<6|(2&1)<<5|(2&1)<<4|(1&1)<<3|(1&1)<<2|(1&1)<<1|(1&1)<<0, 
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(0&1)<<4|(1&1)<<3|(1&1)<<2|(1&1)<<1|(0&1)<<0, 
    (0&1)<<7|(0&1)<<6|(0&1)<<5|(3&1)<<4|(3&1)<<3|(3&1)<<2|(0&1)<<1|(0&1)<<0, 
    (0&1)<<7|(0&1)<<6|(3&1)<<5|(3&1)<<4|(3&1)<<3|(3&1)<<2|(0&1)<<1|(0&1)<<0,

    (0&2)<<7|(0&2)<<6|(0&2)<<5|(3&2)<<4|(3&2)<<3|(3&2)<<2|(1&2)<<1|(3&2)<<0, 
    (0&2)<<7|(0&2)<<6|(3&2)<<5|(3&2)<<4|(3&2)<<3|(3&2)<<2|(1&2)<<1|(1&2)<<0,
    (0&2)<<7|(0&2)<<6|(2&2)<<5|(2&2)<<4|(3&2)<<3|(1&2)<<2|(2&2)<<1|(1&2)<<0, 
    (0&2)<<7|(0&2)<<6|(2&2)<<5|(2&2)<<4|(2&2)<<3|(1&2)<<2|(1&2)<<1|(1&2)<<0, 
    (0&2)<<7|(0&2)<<6|(2&2)<<5|(2&2)<<4|(1&2)<<3|(1&2)<<2|(1&2)<<1|(1&2)<<0, 
    (0&2)<<7|(0&2)<<6|(0&2)<<5|(0&2)<<4|(1&2)<<3|(1&2)<<2|(1&2)<<1|(0&2)<<0, 
    (0&2)<<7|(0&2)<<6|(0&2)<<5|(3&2)<<4|(3&2)<<3|(3&2)<<2|(0&2)<<1|(0&2)<<0, 
    (0&2)<<7|(0&2)<<6|(3&2)<<5|(3&2)<<4|(3&2)<<3|(3&2)<<2|(0&2)<<1|(0&2)<<0,

    (3&1)<<7|(1&1)<<6|(3&1)<<5|(3&1)<<4|(3&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0,
    (1&1)<<7|(1&1)<<6|(3&1)<<5|(3&1)<<4|(3&1)<<3|(3&1)<<2|(0&1)<<1|(0&1)<<0,
    (1&1)<<7|(2&1)<<6|(1&1)<<5|(3&1)<<4|(2&1)<<3|(2&1)<<2|(0&1)<<1|(0&1)<<0,
    (1&1)<<7|(1&1)<<6|(1&1)<<5|(2&1)<<4|(2&1)<<3|(2&1)<<2|(0&1)<<1|(0&1)<<0,
    (1&1)<<7|(1&1)<<6|(1&1)<<5|(1&1)<<4|(2&1)<<3|(2&1)<<2|(0&1)<<1|(0&1)<<0,
    (0&1)<<7|(1&1)<<6|(1&1)<<5|(1&1)<<4|(0&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0,
    (0&1)<<7|(0&1)<<6|(3&1)<<5|(3&1)<<4|(3&1)<<3|(0&1)<<2|(0&1)<<1|(0&1)<<0,
    (0&1)<<7|(0&1)<<6|(3&1)<<5|(3&1)<<4|(3&1)<<3|(3&1)<<2|(0&1)<<1|(0&1)<<0,

    (3&2)<<7|(1&2)<<6|(3&2)<<5|(3&2)<<4|(3&2)<<3|(0&2)<<2|(0&2)<<1|(0&2)<<0,
    (1&2)<<7|(1&2)<<6|(3&2)<<5|(3&2)<<4|(3&2)<<3|(3&2)<<2|(0&2)<<1|(0&2)<<0,
    (1&2)<<7|(2&2)<<6|(1&2)<<5|(3&2)<<4|(2&2)<<3|(2&2)<<2|(0&2)<<1|(0&2)<<0,
    (1&2)<<7|(1&2)<<6|(1&2)<<5|(2&2)<<4|(2&2)<<3|(2&2)<<2|(0&2)<<1|(0&2)<<0,
    (1&2)<<7|(1&2)<<6|(1&2)<<5|(1&2)<<4|(2&2)<<3|(2&2)<<2|(0&2)<<1|(0&2)<<0,
    (0&2)<<7|(1&2)<<6|(1&2)<<5|(1&2)<<4|(0&2)<<3|(0&2)<<2|(0&2)<<1|(0&2)<<0,
    (0&2)<<7|(0&2)<<6|(3&2)<<5|(3&2)<<4|(3&2)<<3|(0&2)<<2|(0&2)<<1|(0&2)<<0,
    (0&2)<<7|(0&2)<<6|(3&2)<<5|(3&2)<<4|(3&2)<<3|(3&2)<<2|(0&2)<<1|(0&2)<<0,
};

u8 NesMain()
{
    int i;
    u8 KeyState = 0;
    u8 x, y;
    Sprite* sp = (Sprite *)SPR_WORK_ADDR;
    Sprite16 sp16[1];

    VSYNC();
    
    //!< 表示オフ
    PPUMASK = 0;
    
    //!< サウンド初期化
    PULSE1_CTRL1 = 0;
    PULSE1_CTRL2 = 0;
    PULSE1_CTRL1 = 0;
    PULSE1_CTRL2 = 0;
    TRIANGLE_CTRL = 0;
    NOISE_CTRL = 0;
    SNDCHANNEL = 0;

    //!< BG クリア
    SET_PPUADDR(PPU_BG_A_NAMETBL_ADDR);
    for(i = 0;i < 0x800;++i) { PPUDATA = 0; }
    //!< BG スクロール
    PPUSCROLL_BG(0, 0);
    PPUCTRL = 0;

    //!< スプライトクリア (消す方法は無いため、画面外に飛ばす)
    SpriteClear(sp);

    //!< SPR パレット
    SET_PPUADDR(PPU_SPR_PALETTE_ADDR);
    for(i = 0;i < COUNTOF(Palette);++i) {
        PPUDATA = Palette[i];
    }
    //!< SPR パターン
    SET_PPUADDR(PPU_PATTERN_ADDR);
    for(i = 0;i < COUNTOF(PatternSPR);++i) {
        PPUDATA = PatternSPR[i];
    }
    for(i = 0;i < SPR_MAX;++i) {
        SpriteRemove(&sp[i]);
        sp[i].TileNo = i & 3;
        sp[i].Attribute = SPR_ATTR_PALETTE(0) | SPR_ATTR_PRI_FRONT_OF_BG;
        //sp[i].Attribute = SPR_ATTR_PALETTE(0) | SPR_ATTR_PRI_FRONT_OF_BG | SPR_ATTR_HFLIP_ON;
        //sp[i].Attribute = SPR_ATTR_PALETTE(0) | SPR_ATTR_PRI_FRONT_OF_BG | SPR_ATTR_VFLIP_ON;
        //sp[i].Attribute = SPR_ATTR_PALETTE(0) | SPR_ATTR_PRI_FRONT_OF_BG | SPR_ATTR_HFLIP_ON | SPR_ATTR_VFLIP_ON;
    }

    x = BG_WIDTH >> 1;
    y = BG_HEIGHT >> 1;
    Sprite16Init(&sp16[0], &sp[0]);
    Sprite16SetPosCC(&sp16[0], x, y);

    //!< 表示オン
    PPUMASK = PPUMASK_SPR_DISP_ON | PPUMASK_SPR_EDGE_ON;
   
    while(1){
        KeyState = ReadJoypad1();
        if(BUTTON_UP & KeyState){ --y; }
        if(BUTTON_DOWN & KeyState){ ++y; }
        if(BUTTON_LEFT & KeyState){ --x; }
        if(BUTTON_RIGHT & KeyState){ ++x; }

        for(i = 0;i < COUNTOF(sp16);++i) {
            Sprite16SetPosCC(&sp16[i], x, y);
        }

        VSYNC();

        //!< スプライトの DMA 転送
        OAM_DMA_START(SPR_WORK_ADDR);
    }
    return 0;
}